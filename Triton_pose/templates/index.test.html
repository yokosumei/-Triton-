<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Triton Pose Test</title>
  <meta name="viewport" content="width=1280, initial-scale=0.8">
  <style>
    :root { color-scheme: dark; }
    /* Stil clasic, compact, fără margini rotunde */
    body{margin:0;background:#111;color:#e6e6e6;font:14px/1.35 system-ui,Segoe UI,Arial,sans-serif}
    header{padding:8px 10px;background:#171717;border-bottom:1px solid #2a2a2a}
    h1{margin:0;font-size:16px;font-weight:600}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:8px}
    .pane{border:1px solid #2a2a2a;background:#141414}
    .pane h3{margin:0;padding:6px 8px;border-bottom:1px solid #2a2a2a;background:#181818;font-size:13px;font-weight:600}
    .pane img{width:100%;height:520px;object-fit:contain;background:#000;display:block}

    .controls{display:flex;flex-wrap:wrap;gap:8px;align-items:center;
              padding:8px;border-top:1px solid #2a2a2a;border-bottom:1px solid #2a2a2a;margin:0 8px}
    button{padding:6px 12px;border:1px solid #3a3a3a;background:#2f6bff;color:#fff;
           font-weight:600;cursor:pointer;border-radius:0}
    button.secondary{background:#3a3a3a}
    button:disabled{opacity:0.65;cursor:not-allowed}
    .status{margin-left:6px;opacity:.9}

    .readout{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:8px;margin:0 8px}
    .badge{display:inline-block;padding:4px 8px;border:1px solid #2a2a2a;background:#1a1a1a;border-radius:0}
    .ok{color:#97e69f}
    .warn{color:#ffd479}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}

    @media (max-width:1200px){
      .grid{grid-template-columns:1fr}
      .pane img{height:360px}
    }
  </style>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
  <header><h1>Triton — Pose + XGB (demo)</h1></header>

  <!-- STREAMURI sus -->
  <div class="grid">
    <div class="pane">
      <h3>RAW</h3>
      <img id="raw" src="/video_feed" alt="raw stream">
    </div>
    <div class="pane">
      <h3>POSE (schelet + scor)</h3>
      <img id="pose" src="/pose_feed" alt="pose stream">
    </div>
  </div>

  <!-- BUTOANE + STATUS sub streamuri -->
  <div class="controls">
    <button id="startBtn">Start analiza</button>
    <button id="stopBtn" class="secondary">Stop</button>
    <span class="status mono" id="statusText">status: idle</span>
    <span class="badge mono" id="queueInfo">queues: kp=0 norm=0 feat=0</span>
    <span class="badge mono" id="modelInfo">label=N/A p=0.000</span>
  </div>

  <!-- DEBUG -->
  <div class="readout mono" id="debug">
    <span id="sock" class="badge">socket: …</span>
    <span id="thr"  class="badge">τ_on/τ_off/cooldown: …</span>
    <span id="running" class="badge">running: false</span>
  </div>

  <script>
  (function(){
    const $ = s => document.querySelector(s);
    const startBtn = $('#startBtn');
    const stopBtn  = $('#stopBtn');
    const statusEl = $('#statusText');
    const queueEl  = $('#queueInfo');
    const modelEl  = $('#modelInfo');
    const sockEl   = $('#sock');
    const thrEl    = $('#thr');
    const runEl    = $('#running');

    function setStatus(t){ statusEl.textContent = 'status: ' + t; }
    function setQueues(kp,norm,feat){ queueEl.textContent = `queues: kp=${kp} norm=${norm} feat=${feat}`; }
    function setModel(label,p){ modelEl.textContent = `label=${label} p=${p.toFixed(3)}`; modelEl.className = 'badge mono ' + (label==='INEC'?'warn':'ok'); }
    function setRunning(b){ runEl.textContent = 'running: ' + b; }

    // Start/Stop
    startBtn.onclick = async ()=>{ try{ await fetch('/start',{method:'POST'}); setStatus('running'); setRunning(true);}catch(e){ setStatus('err start'); } };
    stopBtn.onclick  = async ()=>{ try{ await fetch('/stop' ,{method:'POST'}); setStatus('stopped'); setRunning(false);}catch(e){ setStatus('err stop'); } };

    // SocketIO
    const ioUrl = location.protocol + '//' + location.host;
    const sock = io(ioUrl);
    sock.on('connect', ()=>{ sockEl.textContent = 'socket: connected'; });
    sock.on('disconnect', ()=>{ sockEl.textContent = 'socket: disconnected'; });
    sock.on('decision', (d)=>{
      const label = d?.label ?? 'N/A';
      const p     = +((d?.proba ?? 0));
      setModel(label, p);
    });

    // Debug poll
    async function pollDebug(){
      try{
        const r = await fetch('/debug');
        if(!r.ok) throw 0;
        const j = await r.json();
        setQueues(j.queues.kp, j.queues.norm, j.queues.feat);
        setRunning(!!j.running);
        thrEl.textContent = `τ_on/τ_off/cooldown: ${j.tau_on.toFixed(3)}/${j.tau_off.toFixed(3)}/${j.cooldown_s.toFixed(1)}s`;
      }catch(e){
        // ignore
      }finally{
        setTimeout(pollDebug, 1500);
      }
    }
    pollDebug();

    // Forțează reatașarea feed-urilor după Start/Stop
    function bust(id, path){
      const el = document.getElementById(id);
      el.src = path + '?ts=' + Date.now();
    }
    startBtn.addEventListener('click', ()=>{ bust('raw','/video_feed'); bust('pose','/pose_feed'); });
    stopBtn .addEventListener('click', ()=>{ bust('raw','/video_feed'); bust('pose','/pose_feed'); });
  })();
  </script>
</body>
</html>
